@inject MSGS.ClientManager udpClient
@inject MSGS.ClientSessionData SessionData
@inject NavigationManager Navigation
@inject MSGS.AgentsRepository _agentsRepository
@inject AuthenticationStateProvider AuthStateProvider
@implements IDisposable

@if (!_initialized)
{
    <div class="p-4 text-muted fs-13">Initializing...</div>
}
else
{
    <Router AppAssembly="@typeof(App).Assembly">
        <Found Context="routeData">
            <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)" />
            <FocusOnNavigate RouteData="@routeData" Selector="h1" />
        </Found>
        <NotFound>
            <LayoutView Layout="@typeof(MainLayout)">
                <p>Page not found.</p>
            </LayoutView>
        </NotFound>
    </Router>
}

@code {
    private bool _initialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _initialized)
            return;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            // Not logged in — allow login page, redirect everything else
            var currentPath = Navigation.ToBaseRelativePath(Navigation.Uri)
                                        .ToLowerInvariant().Trim('/');
            bool isLoginPage = string.IsNullOrEmpty(currentPath)
                               || currentPath == "index"
                               || currentPath == "login";

            if (!isLoginPage)
            {
                Console.WriteLine($"[App] Not authenticated, path='{currentPath}' → /login");
                Navigation.NavigateTo("/login", forceLoad: true);
                return;
            }

            // On login page — show it
            _initialized = true;
            StateHasChanged();
            return;
        }

        // Authenticated
        var username = user.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value ?? "";
        var role     = user.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value ?? "";
        Console.WriteLine($"[App] Authenticated: '{username}' role='{role}'");

        if (role == "Admin")
        {
            // Admins don't need a TCP agent
            _initialized = true;
            StateHasChanged();
            return;
        }

        // Customer — verify agent exists in TCP system
        bool isAgentExists = _agentsRepository.GetClientAgentData(username) != null;
        if (!isAgentExists)
        {
            Console.WriteLine($"[App] Agent '{username}' not found (server restart?). Redirecting to /logout");
            Navigation.NavigateTo("/logout", forceLoad: true);
            return;
        }

        udpClient.ClientRefresh(username);
        Console.WriteLine($"[App] ClientRefresh done for '{username}'");
        _initialized = true;
        StateHasChanged();
    }

    public void Dispose()
    {
        udpClient?.Dispose();
    }
}
