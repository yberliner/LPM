@page "/"
@page "/index"
@page "/login"
@layout CustomLayout
@using LPM._Spk
@inject IJSRuntime JS
@inject NavigationManager Nav

<div class="authentication-background">
    <div class="container">
        <div class="row justify-content-center align-items-center authentication h-100">
            <div class="col-xxl-5 col-xl-5 col-lg-5 col-md-6 col-sm-8 col-12">
                <div class="card custom-card my-4">
                    <div class="card-body p-5">

                        <div class="mb-3 d-flex justify-content-center">
                            <a href="/index">
                                <img src="/assets/images/brand-logos/desktop-logo.png" alt="logo" class="desktop-logo authentication-logo" style="height:48px;">
                                <img src="/assets/images/brand-logos/desktop-dark.png"  alt="logo" class="desktop-dark  authentication-logo" style="height:48px;">
                            </a>
                        </div>

                        <p class="h5 mb-2 text-center">Sign In</p>
                        <p class="mb-4 text-muted op-7 fw-normal text-center">Welcome back !</p>

                        <div class="row gy-3">
                            <div class="col-xl-12">
                                <label for="signin-username" class="form-label text-default">
                                    User Name<sup class="fs-12 text-danger">*</sup>
                                </label>
                                <input type="text"
                                       class="form-control"
                                       id="signin-username"
                                       placeholder="Enter user name"
                                       @bind="_username"
                                       @bind:event="oninput"
                                       @onkeydown="HandleKeyDown" />
                            </div>

                            <div class="col-xl-12 mb-2">
                                <label for="signin-password" class="form-label text-default d-block">
                                    Password<sup class="fs-12 text-danger">*</sup>
                                </label>
                                <div @onkeydown="HandleKeyDown">
                                    <SpkPasswordToggle @bind-Password="_password" />
                                </div>
                            </div>
                        </div>

                        @if (_error)
                        {
                            <div class="alert alert-danger text-center mt-3 @(_shake ? "shake" : "")" role="alert">
                                <i class="ri-error-warning-line me-1"></i> Invalid username or password.
                            </div>
                        }

                        <div class="d-grid mt-4">
                            <button class="btn btn-primary btn-wave"
                                    @onclick="HandleLogin"
                                    disabled="@_loading">
                                @if (_loading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                }
                                Sign In
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @@keyframes shake {
        0%   { transform: translateX(0); }
        25%  { transform: translateX(-5px); }
        50%  { transform: translateX(5px); }
        75%  { transform: translateX(-5px); }
        100% { transform: translateX(0); }
    }
    .shake {
        animation: shake 0.3s;
    }
</style>

@code {
    private string _username = "";
    private string _password = "";
    private bool _error;
    private bool _shake;
    private bool _loading;

    protected override void OnInitialized()
    {
        var uri = new Uri(Nav.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        _error = query["error"] == "1";
        _username = query["username"] ?? "";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _error)
            await ShowErrorAsync();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await HandleLogin();
    }

    private async Task HandleLogin()
    {
        if (string.IsNullOrWhiteSpace(_username) || string.IsNullOrWhiteSpace(_password))
            return;

        _loading = true;
        await InvokeAsync(StateHasChanged);
        await JS.InvokeVoidAsync("submitLoginForm", _username, _password);
    }

    private async Task ShowErrorAsync()
    {
        _error = true;
        _shake = true;
        await InvokeAsync(StateHasChanged);
        await Task.Delay(350);
        _shake = false;
        await InvokeAsync(StateHasChanged);
    }
}
