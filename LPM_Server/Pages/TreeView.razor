@implements IDisposable

<div class="raw">
    <button class="btn btn-primary" @onclick="ToggleTreeView">
        @(isCollapsed ? "▶ Expand Tree" : "▼ Collapse Tree")
    </button>

    @if (!isCollapsed && Data != null)
    {
        <ul>
            @foreach (var item in MSGS.ReflectionHelper.GetPropertiesRecursive(Data))
            {
                <TreeItem Key="@item.Key" Value="@item.Value"
                          OnValueChanged="@((change) => modifiedValues[change.Key] = change.Value)"
                          OnUserModified="HandleUserModified" />
            }
        </ul>

        <button hidden="@Hide_Apply_button" @onclick="ApplyAllChanges">✔ Apply Changes</button>
    }
</div>

@code {
    [Parameter] public object? Data { get; set; }
    [Parameter] public bool Hide_Apply_button { get; set; }
    [Parameter] public EventCallback OnUpdate { get; set; }

    private Dictionary<string, object> modifiedValues = new();
    private bool isCollapsed = false; // ✅ Track collapse state

    private void ToggleTreeView()
    {
        isCollapsed = !isCollapsed; // ✅ Toggle collapse state
    }

    private async Task ApplyAllChanges()
    {
        if (Data == null) return;

        Type dataType = Data.GetType();
        var method = typeof(MSGS.ReflectionHelper).GetMethod(nameof(MSGS.ReflectionHelper.ApplyChangesToStruct))?
            .MakeGenericMethod(dataType);

        if (method != null)
        {
            object[] parameters = new object[] { Data, modifiedValues };
            method.Invoke(null, parameters);
            Data = parameters[0]; // ✅ Assign modified struct back
        }

        modifiedValues.Clear();
        await OnUpdate.InvokeAsync(Data);
    }

    private void HandleUserModified(string key)
    {
        Console.WriteLine($"User modified: {key}");
    }

    public void Dispose()
    {
        Console.WriteLine("🚀 TreeView is being disposed!");
        //ApplyAllChanges().Wait();
        modifiedValues.Clear();
    }
}
