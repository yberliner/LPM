@page "/Home"
@using System.Globalization
@using LPM.Services
@attribute [Authorize]
@inject DashboardService DashSvc
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@inject PdfService PdfService

<div @onclick="DismissMenu">

    @* ── Week navigation bar ── *@
    <div class="d-flex align-items-center flex-wrap gap-2 px-3 py-2 border-bottom mb-3">
        <button class="btn btn-sm btn-outline-secondary" @onclick="PrevWeek">← Prev</button>
        <span class="fw-semibold fs-14">
            Week: @DayLabel(_weekStart) – @DayLabel(_weekStart.AddDays(6))
        </span>
        <button class="btn btn-sm btn-outline-secondary" @onclick="NextWeek"
                disabled="@(_weekStart >= DashboardService.GetWeekStart(MaxAllowedDate()))">
            Next →
        </button>
        <button class="btn btn-sm btn-outline-secondary ms-auto" @onclick="PrintTable">
            <i class="ri-printer-line me-1"></i>Print
        </button>
        <button class="btn btn-sm btn-outline-primary" @onclick="ShowAddPcModal">+ Add PC</button>
    </div>

    @if (_userId == null)
    {
        <div class="px-3 text-danger">User record not found in database.</div>
    }
    else if (!_isAuditor && !_isCS)
    {
        <div class="px-3 text-muted">No Auditor or CS role found for this account.</div>
    }
    else
    {
        @* ── Grid ── *@
        <div id="print-zone">
        <div class="table-responsive px-3 thick-scroll">
            <table class="table table-bordered table-hover table-sm mb-0" style="min-width:300px;">
                <thead class="table-light">
                    <tr>
                        <th style="min-width:110px;">Day</th>
                        @foreach (var pc in _myPcs)
                        {
                            <th class="text-center user-select-none"
                                style="cursor:context-menu; white-space:nowrap; min-width:90px;"
                                @oncontextmenu="e => ShowCtxMenu(e, pc.PcId)"
                                @oncontextmenu:preventDefault="true">
                                @pc.FullName
                            </th>
                        }
                        @if (_myPcs.Count == 0)
                        {
                            <th class="text-muted fst-italic fw-normal">
                                Click <strong>+ Add PC</strong> to begin
                            </th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @* ── Role row ── *@
                    @if (_myPcs.Count > 0)
                    {
                        <tr class="table-light">
                            <td class="fw-semibold small text-muted py-1">Role</td>
                            @foreach (var pc in _myPcs)
                            {
                                <td class="text-center py-1">
                                    @if (pc.Role == "Miscellaneous")
                                    {
                                        <span class="badge bg-secondary-transparent">Other</span>
                                    }
                                    else if (_isCS)
                                    {
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn @AudBtnClass(pc)"
                                                    @onclick="() => SetPcRoleAud(pc.PcId)">
                                                Aud
                                            </button>
                                            <button type="button" class="btn @CsBtnClass(pc)"
                                                    @onclick="() => SetPcRoleCs(pc.PcId)">
                                                CS
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="badge bg-primary-transparent">Auditor</span>
                                    }
                                </td>
                            }
                        </tr>
                    }

                    @* ── Day rows ── *@
                    @for (int d = 0; d < 7; d++)
                    {
                        var day      = _weekStart.AddDays(d);
                        var dayIdx   = d;
                        var isFuture = day > MaxAllowedDate();
                        <tr>
                            <td class="text-nowrap @(isFuture ? "text-muted" : "")">@DayLabel(day)</td>
                            @if (_myPcs.Count == 0)
                            {
                                <td class="text-muted text-center small">—</td>
                            }
                            else
                            {
                                @foreach (var pc in _myPcs)
                                {
                                    var secs       = _grid.GetValueOrDefault((pc.PcId, dayIdx));
                                    var isSelected = _selPcId == pc.PcId && _selDay == dayIdx;
                                    <td class="text-center @(isSelected ? "table-primary fw-semibold" : isFuture ? "text-muted" : "")"
                                        style="@(isFuture ? "cursor:default; background:#f8f9fa; opacity:.55;" : "cursor:pointer;")"
                                        @onclick="() => TrySelectCell(pc.PcId, dayIdx)">
                                        @DashboardService.Fmt(secs)
                                    </td>
                                }
                            }
                        </tr>
                    }
                </tbody>
                @if (_myPcs.Count > 0)
                {
                    <tfoot class="table-light">
                        <tr>
                            <td><strong>Σ Week</strong></td>
                            @foreach (var pc in _myPcs)
                            {
                                var total = Enumerable.Range(0, 7)
                                    .Sum(d => _grid.GetValueOrDefault((pc.PcId, d)));
                                <td class="text-center">
                                    <strong>@DashboardService.Fmt(total)</strong>
                                </td>
                            }
                        </tr>
                        <tr style="background:linear-gradient(90deg,#1a237e 0%,#283593 100%); color:#fff;">
                            <td class="fw-bold" style="letter-spacing:.03em;">Grand Total</td>
                            <td colspan="@_myPcs.Count" class="text-center">
                                <span style="font-size:1.25rem; font-weight:700; letter-spacing:.04em;">
                                    @DashboardService.Fmt(_grid.Values.Sum())
                                </span>
                            </td>
                        </tr>
                    </tfoot>
                }
            </table>
        </div>
        </div>

        @* ── Context menu ── *@
        @if (_showCtxMenu)
        {
            var ctxPc = _myPcs.FirstOrDefault(p => p.PcId == _ctxPcId);
            <div class="card shadow-sm border"
                 style="position:fixed; top:@(_ctxY)px; left:@(_ctxX)px; z-index:9999; min-width:160px;"
                 @onclick:stopPropagation="true">
                <div class="list-group list-group-flush">
                    @if (ctxPc?.Role == "Miscellaneous")
                    {
                        <button class="list-group-item list-group-item-action py-2"
                                @onclick="RemoveFromOthers">
                            <i class="ri-corner-up-left-line me-2"></i>Remove from Others
                        </button>
                    }
                    else
                    {
                        <button class="list-group-item list-group-item-action py-2"
                                @onclick="SetAsOther">
                            <i class="ri-shuffle-line me-2"></i>Set as Other
                        </button>
                    }
                    <button class="list-group-item list-group-item-action text-danger py-2"
                            @onclick="RemovePc">
                        <i class="ri-delete-bin-line me-2"></i>Remove PC
                    </button>
                </div>
            </div>
        }

        @* ── Detail panel ── *@
        @if (_selPcId.HasValue && _selDay.HasValue && _detail != null)
        {
            var selPcName = _myPcs.FirstOrDefault(p => p.PcId == _selPcId.Value)?.FullName ?? "";
            var selDate   = _weekStart.AddDays(_selDay.Value);
            var roleLabel = _selRole == "CS" ? "CS" : _selRole == "Miscellaneous" ? "Other" : "Auditor";

            <div class="card mx-3 mt-3 mb-3" @onclick:stopPropagation="true">
                <div class="card-header d-flex align-items-center gap-2 py-2">
                    <strong>@selPcName — @DayLabel(selDate)</strong>
                    <span class="badge @(_selRole == "CS" ? "bg-success-transparent" : _selRole == "Miscellaneous" ? "bg-secondary-transparent" : "bg-primary-transparent") ms-1">
                        @roleLabel
                    </span>
                    <button class="btn-close ms-auto" title="Close" @onclick="ClearSelection"></button>
                </div>
                <div class="card-body py-2">

                    @if (_selRole != "CS")
                    {
                        @* ── Auditor view: own sessions (also used for Miscellaneous/Other role) ── *@
                        @if (_detail.Sessions.Count == 0)
                        {
                            <p class="text-muted mb-2 small">No sessions recorded for this day.</p>
                        }
                        else
                        {
                            <ul class="list-unstyled mb-2">
                                @foreach (var s in _detail.Sessions)
                                {
                                    <li class="mb-1 d-flex align-items-center flex-wrap gap-2">
                                        <span class="badge bg-primary-transparent fs-12">
                                            @DashboardService.Fmt(s.LengthSec)
                                        </span>
                                        @if (s.AdminSec > 0)
                                        {
                                            <span class="text-muted small">
                                                (Admin: @DashboardService.Fmt(s.AdminSec))
                                            </span>
                                        }
                                        @if (s.IsFree)
                                        {
                                            <span class="badge bg-warning-transparent">Free</span>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(s.Summary))
                                        {
                                            <em class="text-muted small">"@s.Summary"</em>
                                        }
                                    </li>
                                }
                            </ul>
                        }

                        @* Add Session / Misc Entry button and form *@
                        @if (!_showAddSession)
                        {
                            <button class="btn btn-sm btn-outline-primary"
                                    @onclick="OpenAddSession">
                                @(_selRole == "Miscellaneous" ? "+ Add Misc Entry" : "+ Add Session")
                            </button>
                        }
                        else
                        {
                            <div class="border rounded p-3 mt-2 bg-light">
                                <h6 class="mb-2">@(_selRole == "Miscellaneous" ? "Add Misc Entry" : "Add Session")</h6>
                                <div class="row g-2 align-items-end">
                                    <div class="col-auto">
                                        <label class="form-label mb-0 small">Duration (H:MM)</label>
                                        <input class="form-control form-control-sm"
                                               style="width:90px;" placeholder="1:30"
                                               @bind="_addDuration" @bind:event="oninput" />
                                    </div>
                                    <div class="col-auto">
                                        <label class="form-label mb-0 small">Admin min</label>
                                        <input class="form-control form-control-sm"
                                               style="width:70px;" type="number" min="0"
                                               @bind="_addAdminMin" />
                                    </div>
                                    <div class="col-auto d-flex align-items-end pb-1">
                                        <div class="form-check mb-0">
                                            <input class="form-check-input" type="checkbox"
                                                   id="chkFree" @bind="_addIsFree" />
                                            <label class="form-check-label small" for="chkFree">Free</label>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <label class="form-label mb-0 small">Summary</label>
                                        <input class="form-control form-control-sm"
                                               placeholder="Notes..."
                                               @bind="_addSummary" />
                                    </div>
                                    <div class="col-auto">
                                        <button class="btn btn-sm btn-primary" @onclick="SaveSession">Save</button>
                                        <button class="btn btn-sm btn-link text-danger"
                                                @onclick="CancelAddSession">Cancel</button>
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(_addError))
                                {
                                    <div class="text-danger small mt-1">@_addError</div>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        @* ── CS view: all sessions (read-only) with review status ── *@
                        @if (_detail.Sessions.Count == 0)
                        {
                            <p class="text-muted mb-2 small">No sessions recorded for this day.</p>
                        }
                        else
                        {
                            <ul class="list-unstyled mb-2">
                                @foreach (var s in _detail.Sessions)
                                {
                                    var rev = _detail.Reviews.FirstOrDefault(r => r.SessionId == s.SessionId);
                                    <li class="mb-2 border rounded p-2">
                                        <div class="d-flex align-items-center flex-wrap gap-2 mb-1">
                                            <span class="fw-semibold small">@s.AuditorName</span>
                                            <span class="badge bg-primary-transparent fs-12">
                                                @DashboardService.Fmt(s.LengthSec)
                                            </span>
                                            @if (s.AdminSec > 0)
                                            {
                                                <span class="text-muted small">
                                                    (Admin: @DashboardService.Fmt(s.AdminSec))
                                                </span>
                                            }
                                            @if (s.IsFree)
                                            {
                                                <span class="badge bg-warning-transparent">Free</span>
                                            }
                                            @if (!string.IsNullOrWhiteSpace(s.Summary))
                                            {
                                                <em class="text-muted small">"@s.Summary"</em>
                                            }
                                        </div>
                                        @if (rev != null)
                                        {
                                            <div class="d-flex align-items-center gap-2 small">
                                                <i class="ri-checkbox-circle-line text-success"></i>
                                                <span class="badge bg-success-transparent">
                                                    @DashboardService.Fmt(rev.ReviewSec)
                                                </span>
                                                <span>@rev.Status</span>
                                                @if (!string.IsNullOrWhiteSpace(rev.Notes))
                                                {
                                                    <em class="text-muted">"@rev.Notes"</em>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-outline-success py-0 mt-1"
                                                    @onclick="() => StartAddReview(s.SessionId)">
                                                + CS Review
                                            </button>
                                        }
                                    </li>
                                }
                            </ul>
                        }

                        @* Add CS Review form *@
                        @if (_showAddReview)
                        {
                            <div class="border rounded p-3 mt-2 bg-light">
                                <h6 class="mb-2">Add CS Review (Session #@_addReviewSessionId)</h6>
                                <div class="row g-2 align-items-end">
                                    <div class="col-auto">
                                        <label class="form-label mb-0 small">Duration (H:MM)</label>
                                        <input class="form-control form-control-sm"
                                               style="width:90px;" placeholder="0:30"
                                               @bind="_addReviewDuration" @bind:event="oninput" />
                                    </div>
                                    <div class="col-auto">
                                        <label class="form-label mb-0 small">Status</label>
                                        <select class="form-select form-select-sm"
                                                @bind="_addReviewStatus">
                                            <option value="Approved">Approved</option>
                                            <option value="NeedsCorrection">Needs Correction</option>
                                            <option value="Rejected">Rejected</option>
                                        </select>
                                    </div>
                                    <div class="col">
                                        <label class="form-label mb-0 small">Notes</label>
                                        <input class="form-control form-control-sm"
                                               placeholder="Notes..."
                                               @bind="_addReviewNotes" />
                                    </div>
                                    <div class="col-auto">
                                        <button class="btn btn-sm btn-primary" @onclick="SaveReview">Save</button>
                                        <button class="btn btn-sm btn-link text-danger"
                                                @onclick="CancelAddReview">Cancel</button>
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(_reviewError))
                                {
                                    <div class="text-danger small mt-1">@_reviewError</div>
                                }
                            </div>
                        }

                        @* ── General CS Work ── *@
                        <hr class="my-2" />
                        <div class="fw-semibold small text-muted mb-1">General CS Work</div>
                        @if (_detail.GeneralWork != null && _detail.GeneralWork.Count > 0)
                        {
                            <ul class="list-unstyled mb-2">
                                @foreach (var w in _detail.GeneralWork)
                                {
                                    <li class="mb-1 d-flex align-items-center gap-2">
                                        <span class="badge bg-info-transparent fs-12">
                                            @DashboardService.Fmt(w.LengthSec)
                                        </span>
                                        @if (!string.IsNullOrWhiteSpace(w.Notes))
                                        {
                                            <em class="text-muted small">"@w.Notes"</em>
                                        }
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p class="text-muted small mb-1">No general CS work recorded.</p>
                        }

                        @if (!_showAddGeneralCs)
                        {
                            <button class="btn btn-sm btn-outline-info"
                                    @onclick="OpenAddGeneralCs">
                                + General CS
                            </button>
                        }
                        else
                        {
                            <div class="border rounded p-3 mt-2 bg-light">
                                <h6 class="mb-2">Add General CS Work</h6>
                                <div class="row g-2 align-items-end">
                                    <div class="col-auto">
                                        <label class="form-label mb-0 small">Duration (H:MM)</label>
                                        <input class="form-control form-control-sm"
                                               style="width:90px;" placeholder="0:30"
                                               @bind="_addGeneralCsDuration" @bind:event="oninput" />
                                    </div>
                                    <div class="col">
                                        <label class="form-label mb-0 small">Notes</label>
                                        <input class="form-control form-control-sm"
                                               placeholder="Notes..."
                                               @bind="_addGeneralCsNotes" />
                                    </div>
                                    <div class="col-auto">
                                        <button class="btn btn-sm btn-primary" @onclick="SaveGeneralCs">Save</button>
                                        <button class="btn btn-sm btn-link text-danger"
                                                @onclick="CancelAddGeneralCs">Cancel</button>
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(_generalCsError))
                                {
                                    <div class="text-danger small mt-1">@_generalCsError</div>
                                }
                            </div>
                        }
                    }

                </div>
            </div>
        }

        @* ── Weekly History Chart ── *@
        @if (_weeklyTotals.Count > 0)
        {
            <div class="card mx-3 mt-4 mb-3">
                <div class="card-header py-2 d-flex align-items-center gap-2"
                     style="background:linear-gradient(90deg,#1a237e 0%,#283593 100%); color:#fff;">
                    <strong class="fs-14">Weekly Hours — Last 20 Weeks</strong>
                    <span class="ms-auto small opacity-75">
                        Total: @DashboardService.Fmt(_weeklyTotals.Sum(w => w.TotalSeconds))
                    </span>
                </div>
                <div class="card-body py-1 px-2">
                    <ApexChart TItem="WeekTotal"
                               Options="@_chartOptions"
                               Height="220"
                               @key="_chartKey">
                        <ApexPointSeries TItem="WeekTotal"
                                         Items="@_weeklyTotals"
                                         Name="Hours"
                                         SeriesType="SeriesType.Bar"
                                         XValue="@(w => w.WeekLabel)"
                                         YValue="@(w => Math.Round((decimal)w.TotalSeconds / 3600m, 2))" />
                    </ApexChart>
                </div>
            </div>
        }

        @* ── Add-PC modal ── *@
        @if (_showAddPcModal)
        {
            <div class="modal show d-block" tabindex="-1"
                 style="background:rgba(0,0,0,.4);"
                 @onclick="() => _showAddPcModal = false">
                <div class="modal-dialog modal-dialog-centered"
                     @onclick:stopPropagation="true">
                    <div class="modal-content">
                        <div class="modal-header py-2">
                            <h5 class="modal-title fs-15">Add PC to Dashboard</h5>
                            <button type="button" class="btn-close"
                                    @onclick="() => _showAddPcModal = false"></button>
                        </div>
                        <div class="modal-body">
                            <input class="form-control mb-3" placeholder="Search..."
                                   @bind="_pcSearch" @bind:event="oninput" />
                            <div style="max-height:320px; overflow-y:auto;">
                                @{
                                    var myPcIds   = _myPcs.Select(p => p.PcId).ToHashSet();
                                    var available = _allPcs
                                        .Where(p => !myPcIds.Contains(p.PcId))
                                        .Where(p => string.IsNullOrEmpty(_pcSearch)
                                                    || p.FullName.Contains(_pcSearch,
                                                           StringComparison.OrdinalIgnoreCase))
                                        .ToList();
                                }
                                @if (available.Count == 0)
                                {
                                    <p class="text-muted text-center">No PCs available to add.</p>
                                }
                                @foreach (var pc in available)
                                {
                                    <div class="list-group-item list-group-item-action"
                                         style="cursor:pointer;"
                                         @onclick="() => AddPc(pc.PcId)">
                                        @pc.FullName
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }

</div>

@code {

    string _displayName = "LP Management";

    int?          _userId;
    bool          _isAuditor, _isCS;
    DateOnly      _weekStart;
    List<PcInfo>  _myPcs  = [];
    List<PcInfo>  _allPcs = [];
    Dictionary<(int, int), int> _grid = [];

    int?       _selPcId;
    int?       _selDay;
    string     _selRole = "Auditor";
    DayDetail? _detail;

    // Add Session form
    bool   _showAddSession;
    string _addDuration = "";
    string _addAdminMin = "0";
    bool   _addIsFree;
    string _addSummary  = "";
    string _addError    = "";

    // Add CS Review form
    bool   _showAddReview;
    int    _addReviewSessionId;
    string _addReviewDuration = "";
    string _addReviewStatus   = "Approved";
    string _addReviewNotes    = "";
    string _reviewError       = "";

    // Add General CS form
    bool   _showAddGeneralCs;
    string _addGeneralCsDuration = "";
    string _addGeneralCsNotes    = "";
    string _generalCsError       = "";

    // Context menu
    bool   _showCtxMenu;
    int    _ctxPcId;
    double _ctxX, _ctxY;

    // Add-PC modal
    bool   _showAddPcModal;
    string _pcSearch = "";

    // Weekly history chart
    List<WeekTotal> _weeklyTotals = [];
    int _chartKey;
    ApexChartOptions<WeekTotal> _chartOptions = new()
    {
        Chart = new Chart { Toolbar = new Toolbar { Show = false }, Background = "transparent" },
        PlotOptions = new PlotOptions { Bar = new PlotOptionsBar { ColumnWidth = "65%", BorderRadius = 4 } },
        Colors = new List<string> { "#3949ab" },
        Xaxis = new XAxis { Labels = new XAxisLabels { Rotate = -45, Style = new AxisLabelStyle { FontSize = "11px" } } },
        Grid = new Grid { BorderColor = "#e0e0e0" },
    };

    protected override async Task OnInitializedAsync()
    {
        var auth     = await AuthStateProvider.GetAuthenticationStateAsync();
        var username = auth.User.Identity?.Name ?? "";
        _displayName = username.Length > 0
            ? char.ToUpper(username[0]) + username[1..]
            : "LP Management";

        _userId = DashSvc.GetUserIdByUsername(username);
        if (_userId.HasValue)
        {
            _isAuditor = DashSvc.IsAuditor(_userId.Value);
            _isCS      = DashSvc.IsCS(_userId.Value);
        }
        _weekStart = DashboardService.GetWeekStart(DateOnly.FromDateTime(DateTime.Today));
        await RefreshAsync();
    }

    async Task RefreshAsync()
    {
        if (!_userId.HasValue) return;
        _myPcs  = DashSvc.GetUserPcs(_userId.Value);
        _allPcs = DashSvc.GetAllPcs();
        _grid          = DashSvc.GetWeekGrid(_userId.Value, _weekStart, _myPcs);
        _weeklyTotals  = DashSvc.GetWeeklyTotals(_userId.Value,
                             DashboardService.GetWeekStart(DateOnly.FromDateTime(DateTime.Today)),
                             20, _myPcs);
        _detail = null; _selPcId = null; _selDay = null;
        await InvokeAsync(StateHasChanged);
    }

    async Task PrevWeek() { _weekStart = _weekStart.AddDays(-7); await RefreshAsync(); }
    async Task NextWeek()
    {
        var next = _weekStart.AddDays(7);
        if (next > DashboardService.GetWeekStart(MaxAllowedDate())) return;
        _weekStart = next;
        await RefreshAsync();
    }

    // ── Future-date guard ──
    /// Server date + 1 day if server clock is past 14:00 (covers ≤10h timezone difference)
    static DateOnly MaxAllowedDate()
    {
        var now = DateTime.Now;
        var d   = DateOnly.FromDateTime(now);
        return now.Hour >= 14 ? d.AddDays(1) : d;
    }

    static bool IsFutureDate(DateOnly d) => d > MaxAllowedDate();

    void TrySelectCell(int pcId, int dayIdx)
    {
        if (IsFutureDate(_weekStart.AddDays(dayIdx))) return;
        SelectCell(pcId, dayIdx);
    }

    // ── Role toggle ──
    void SetPcRoleAud(int pcId) => SetPcRole(pcId, "Auditor");
    void SetPcRoleCs(int pcId)  => SetPcRole(pcId, "CS");

    void SetPcRole(int pcId, string role)
    {
        DashSvc.SetUserPcRole(_userId!.Value, pcId, role);
        _myPcs = DashSvc.GetUserPcs(_userId.Value);
        _grid  = DashSvc.GetWeekGrid(_userId.Value, _weekStart, _myPcs);
        if (_selPcId == pcId) ClearSelection();
    }

    string AudBtnClass(PcInfo pc) =>
        pc.Role == "Auditor" ? "btn-sm btn-primary" : "btn-sm btn-outline-secondary";
    string CsBtnClass(PcInfo pc) =>
        pc.Role == "CS" ? "btn-sm btn-success" : "btn-sm btn-outline-secondary";

    // ── Context menu ──
    void ShowCtxMenu(MouseEventArgs e, int pcId)
    {
        _showCtxMenu = true;
        _ctxPcId = pcId;
        _ctxX = e.ClientX;
        _ctxY = e.ClientY;
    }

    void DismissMenu() => _showCtxMenu = false;

    async Task RemovePc()
    {
        DashSvc.RemoveUserPc(_userId!.Value, _ctxPcId);
        _showCtxMenu = false;
        await RefreshAsync();
    }

    void SetAsOther()
    {
        DashSvc.SetUserPcRole(_userId!.Value, _ctxPcId, "Miscellaneous");
        _showCtxMenu = false;
        _myPcs = DashSvc.GetUserPcs(_userId.Value);
        _grid  = DashSvc.GetWeekGrid(_userId.Value, _weekStart, _myPcs);
        if (_selPcId == _ctxPcId) ClearSelection();
    }

    void RemoveFromOthers()
    {
        DashSvc.SetUserPcRole(_userId!.Value, _ctxPcId, "Auditor");
        _showCtxMenu = false;
        _myPcs = DashSvc.GetUserPcs(_userId.Value);
        _grid  = DashSvc.GetWeekGrid(_userId.Value, _weekStart, _myPcs);
        if (_selPcId == _ctxPcId) ClearSelection();
    }

    async Task PrintTable()
    {
        var pdfBytes = PdfService.GenerateWeeklyTablePdf(_displayName, _weekStart, _myPcs, _grid);

        var fileName = $"Week_{_weekStart:yyyy_MM_dd}.pdf";
        await JS.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(pdfBytes));
    }

    // ── Add-PC modal ──
    void ShowAddPcModal() { _showAddPcModal = true; _pcSearch = ""; }

    async Task AddPc(int pcId)
    {
        DashSvc.AddUserPc(_userId!.Value, pcId);
        _showAddPcModal = false;
        _pcSearch = "";
        await RefreshAsync();
    }

    // ── Cell selection ──
    void SelectCell(int pcId, int dayIdx)
    {
        _selPcId = pcId;
        _selDay  = dayIdx;
        _selRole = _myPcs.FirstOrDefault(p => p.PcId == pcId)?.Role ?? "Auditor";
        _detail  = DashSvc.GetDayDetail(_userId!.Value, pcId, _weekStart.AddDays(dayIdx), _selRole);
        _showAddSession  = false;
        _showAddReview   = false;
        _showAddGeneralCs = false;
        _addError        = "";
        _reviewError     = "";
        _generalCsError  = "";
    }

    void ClearSelection() { _selPcId = null; _selDay = null; _detail = null; }

    // ── Add Session ──
    void OpenAddSession()   { _showAddSession = true;  _addError = ""; }
    void CancelAddSession() { _showAddSession = false; _addError = ""; }

    void SaveSession()
    {
        int secs = ParseTime(_addDuration);
        if (secs <= 0) { _addError = "Invalid duration — use H:MM (e.g. 1:30)."; return; }
        if (!int.TryParse(_addAdminMin, out int adminMin) || adminMin < 0)
        {
            _addError = "Invalid admin time.";
            return;
        }

        if (_selRole == "Miscellaneous")
            DashSvc.AddMiscCharge(
                _userId!.Value, _selPcId!.Value,
                _weekStart.AddDays(_selDay!.Value),
                secs, adminMin * 60, _addIsFree,
                string.IsNullOrWhiteSpace(_addSummary) ? null : _addSummary);
        else
            DashSvc.AddSession(
                _userId!.Value, _selPcId!.Value,
                _weekStart.AddDays(_selDay!.Value),
                secs, adminMin * 60, _addIsFree,
                string.IsNullOrWhiteSpace(_addSummary) ? null : _addSummary);

        _showAddSession = false;
        _addDuration = ""; _addAdminMin = "0"; _addIsFree = false;
        _addSummary = ""; _addError = "";

        _detail = DashSvc.GetDayDetail(_userId.Value, _selPcId.Value,
            _weekStart.AddDays(_selDay.Value), _selRole);
        _grid = DashSvc.GetWeekGrid(_userId.Value, _weekStart, _myPcs);
        RefreshWeeklyTotals();
    }

    // ── Add CS Review ──
    void StartAddReview(int sessionId)
    {
        _addReviewSessionId = sessionId;
        _showAddReview      = true;
        _reviewError        = "";
    }

    void CancelAddReview() { _showAddReview = false; _reviewError = ""; }

    // ── Add General CS ──
    void OpenAddGeneralCs()   { _showAddGeneralCs = true;  _generalCsError = ""; }
    void CancelAddGeneralCs() { _showAddGeneralCs = false; _generalCsError = ""; }

    void SaveGeneralCs()
    {
        int secs = ParseTime(_addGeneralCsDuration);
        if (secs <= 0) { _generalCsError = "Invalid duration — use H:MM (e.g. 0:30)."; return; }

        DashSvc.AddCsWork(
            _userId!.Value, _selPcId!.Value,
            _weekStart.AddDays(_selDay!.Value),
            secs,
            string.IsNullOrWhiteSpace(_addGeneralCsNotes) ? null : _addGeneralCsNotes);

        _showAddGeneralCs = false;
        _addGeneralCsDuration = ""; _addGeneralCsNotes = ""; _generalCsError = "";

        _detail = DashSvc.GetDayDetail(_userId.Value, _selPcId.Value,
            _weekStart.AddDays(_selDay.Value), _selRole);
        _grid = DashSvc.GetWeekGrid(_userId.Value, _weekStart, _myPcs);
        RefreshWeeklyTotals();
    }

    void SaveReview()
    {
        int secs = ParseTime(_addReviewDuration);
        if (secs <= 0) { _reviewError = "Invalid duration — use H:MM (e.g. 0:30)."; return; }

        try
        {
            DashSvc.AddCsReview(
                _userId!.Value, _addReviewSessionId, secs, _addReviewStatus,
                string.IsNullOrWhiteSpace(_addReviewNotes) ? null : _addReviewNotes);
        }
        catch (Exception ex) when (ex.Message.Contains("UNIQUE"))
        {
            _reviewError = "A CS review already exists for this session.";
            return;
        }

        _showAddReview = false;
        _addReviewDuration = ""; _addReviewStatus = "Approved";
        _addReviewNotes = ""; _reviewError = "";

        _detail = DashSvc.GetDayDetail(_userId!.Value, _selPcId!.Value,
            _weekStart.AddDays(_selDay!.Value), _selRole);
        _grid = DashSvc.GetWeekGrid(_userId.Value, _weekStart, _myPcs);
        RefreshWeeklyTotals();
    }

    void RefreshWeeklyTotals()
    {
        _weeklyTotals = DashSvc.GetWeeklyTotals(
            _userId!.Value,
            DashboardService.GetWeekStart(DateOnly.FromDateTime(DateTime.Today)),
            20, _myPcs);
        _chartKey++;
    }

    // ── Helpers ──
    static int ParseTime(string input)
    {
        if (string.IsNullOrWhiteSpace(input)) return 0;

        input = input.Trim();

        // If user typed only minutes (e.g. "45")
        if (!input.Contains(':'))
        {
            if (!int.TryParse(input, out int minutes) || minutes < 0) return 0;
            return minutes * 60;
        }

        // If user typed H:MM or HH:MM
        var parts = input.Split(':', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        if (parts.Length != 2) return 0;

        if (!int.TryParse(parts[0], out int hours) || hours < 0) return 0;
        if (!int.TryParse(parts[1], out int minutesPart) || minutesPart < 0 || minutesPart > 59) return 0;

        return (hours * 3600) + (minutesPart * 60);
    }

    static string DayLabel(DateOnly d) =>
        d.ToString("ddd dd/MM", CultureInfo.InvariantCulture);
}
