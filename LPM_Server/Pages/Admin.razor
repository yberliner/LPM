@page "/Admin"
@inject Microsoft.AspNetCore.Components.NavigationManager NavigationManager // This line is used to generate URLs dynamically //
@inherits BaseComponent<MSGS.RKS2RC_Control, MSGS.RC2RKS_Status>
@inject MSGS.ClientManager udpData
@inject IFileStore _fileStore
@inject DevTableVisibilityService DevTableVisibility
@using LPM.Data
@inject AllScriptResServices AllScriptResServices
@inject IJSRuntime JS
@inject OutgoingMsgsManager outMsgsManager
@inject AgentsRepository AgentsRepository
@inject ClientManager ClientManager
@inject OrdersExcelToJson ordersExcelToJson
@inject CustomerReservationsProvider customerReservationsProvider
@using CardModel
@using System.Text.RegularExpressions;
@using ApexSeries

@using FSMSGS
@using MSGS
@using LPM
@using LPM._Spk
@using Microsoft.AspNetCore.Components.Forms;
@using System.Text

<!-- Page Header -->
<SpkPageHeader PageItems="PageItems" />
<!-- Page Header Close -->

<div class="row">
    <div class="col-12">
        <div class="card custom-card">
            <div class="card-body">
                <ul class="nav nav-pills justify-content-center nav-style-2 mb-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" role="tab" aria-current="page"
                           href="#UploadExcel" aria-selected="true">Admin</a>
                    </li>
                </ul>


                 <div class="tab-content">
                    <div class="tab-pane show active text-muted" id="UploadExcel" role="tabpanel">
                        <div class="row">
                            <div class="col-xxl-9 col-xl-10 col-lg-12">
                                <div class="row">
                                    <table>
                                        
                                        <tr class="h-50">
                                            <td>
                                                <div class="btn-list flex-fill mx-5">
                                                    
                                                    <label class="btn btn-primary btn-wave" data-bs-toggle="tooltip" data-bs-placement="top" title="Click here to upload the new excel reservations file" style="margin: 0 0.375rem 0.375rem 0;">
                                                        Upload new Excel file
                                                        <InputFile OnChange="GetBitConfigAsync" @ref="getInput" accept=".xlsx" style="display:none;" />
                                                    </label>
                                                    
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="h-50">
                                            <div class="accordion-body" style="padding:0;">
                                                <SpkCustomer name="Undelivered reservations last 50 days" Orders=@customerOrders TableStyle="height:400px;" />
                                            </div>
                                        

                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                       
                    </div> 
                </div>
            </div>
        </div>
    </div>
</div>

<SpkModalSpinner @ref="_SpinnerDlg" />

@code {
    private SpkModalSpinner? _SpinnerDlg;
    private InputFile getInput = default!;          // ref target

    List<OrderRow>? customerOrders = new List<OrderRow>();

    private List<SpkPageHeader.PageItem> PageItems = new List<SpkPageHeader.PageItem> {
        new SpkPageHeader.PageItem { PageTitle = "Upload Excel File" },
    };

    private async Task GetBitConfigAsync(InputFileChangeEventArgs e)
    {
        try
        {
            if (e.FileCount == 0)
                return;

            Console.WriteLine("Starting Excel to JSON conversion...");

            await _SpinnerDlg!.ShowAsync();

            var file = e.File;

            // ⬇ Save original Excel BEFORE conversion
            await SaveOriginalExcelAsync(file);

            await using var read = file.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024); // 1MB

            var jsonPath = await ordersExcelToJson.BuildJsonFileFromExcelAsync(
                read,
                outputDir: "OutOrdersJson",
                outputFileBaseName: Path.GetFileNameWithoutExtension(file.Name));

            //var orders = await customerReservationsProvider.GetCustomerReservationsFromExcelAsync("122");

            if (jsonPath == null)
            {
                Console.WriteLine("Orders JSON was not created.");
            }
            else
            {
                Console.WriteLine($"Orders JSON created: {jsonPath}");
            }

            await customerReservationsProvider.ClearCacheAsync();

            await refreshData();

        }
        catch (Exception ee)
        {

            Console.WriteLine($"Error in Converting excel file: {ee.Message}");
        }
        finally
        {
            await _SpinnerDlg!.HideAsync();
        }
    }

    private static async Task SaveOriginalExcelAsync(IBrowserFile file)
    {
        try
        {
            Directory.CreateDirectory("Excel");

            string timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
            string originalName = Path.GetFileNameWithoutExtension(file.Name);
            string excelPath = Path.Combine("Excel", $"{originalName}_{timestamp}.xlsx");

            await using var sourceStream = file.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024);
            await using var targetStream = File.Create(excelPath);

            await sourceStream.CopyToAsync(targetStream);

            Console.WriteLine($"Original Excel file saved: {excelPath}");
        }
        catch (Exception ex)
        {
            // Non-fatal: log and continue
            Console.WriteLine($"Failed to save original Excel file: {ex.Message}");
        }
    }

    protected async override void OnInitialized()
    {
        Console.WriteLine("Admin page initialized");
        await refreshData();
    }    

    protected async Task refreshData()
    {
       Console.WriteLine("Refreshing customer orders data...");
       customerOrders = await customerReservationsProvider.GetAllCustomerPerStatusDiff(50, "Delivered");
       await InvokeAsync(StateHasChanged);
    }


}