@using CardModel
@inherits ForsightTester.Shared.AccordionInputBase
@using MSGS
@* ---------- markup ---------- *@
<div class="motor-wrapper my-2 mx-2">
    <div class="accordion accordion-primary" id="@ParentId">
        <div class="accordion-item motor-card">
            <h2 class="accordion-header" id="@HeadingId">
                <button class="accordion-button"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#@CollapseId"
                aria-controls="@CollapseId"
                aria-expanded="true"
                style="background: transparent;">
                    Bit Config
                </button>
            </h2>

            <div id="@CollapseId"
                class="accordion-collapse collapse show"
                aria-labelledby="@HeadingId"
                data-bs-parent="#@ParentId">

                <div class="accordion-body" style="padding:0;">
                    <table class="table table-sm motor-table mb-0" style="@TableStyle">
                        <thead>
                            <tr>
                                <th class="text-center" style="width:10%;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="ms-3">Rule #</span>
                                        <div class="@ArrowCss(0)" @onclick="() => ArrowClicked(0)">
                                            <i class="ri-arrow-down-fill"></i>
                                        </div>
                                    </div>
                                </th>
                                <th class="text-center" style="width:15%;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="ms-3">Error</span>
                                        <div class="@ArrowCss(5)" @onclick="() => ArrowClicked(5)">
                                            <i class="ri-arrow-down-fill"></i>
                                        </div>
                                    </div>
                                </th>
                                <th class="text-center" style="width:15%;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="ms-3">Sub System</span>
                                        <div class="@ArrowCss(1)" @onclick="() => ArrowClicked(1)">
                                            <i class="ri-arrow-down-fill"></i>
                                        </div>
                                    </div>
                                </th>
                                <th class="text-center" style="width:15%;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="ms-3">Module</span>
                                        <div class="@ArrowCss(4)" @onclick="() => ArrowClicked(4)">
                                            <i class="ri-arrow-down-fill"></i>
                                        </div>
                                    </div>
                                </th>
                                <th class="text-center" style="width:15%;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="ms-3">Unit</span>
                                        <div class="@ArrowCss(3)" @onclick="() => ArrowClicked(3)">
                                            <i class="ri-arrow-down-fill"></i>
                                        </div>
                                    </div>
                                </th>
                                <th class="text-center" style="width:15%;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="ms-3">Sub Test</span>
                                        <div class="@ArrowCss(2)" @onclick="() => ArrowClicked(2)">
                                            <i class="ri-arrow-down-fill"></i>
                                        </div>
                                    </div>
                                </th>                                
                                <th class="text-left" style="width:15%;">
                                    <span class="ms-3">Status</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < RulesList.Count; i++)
                            {
                                int Locali = i;
                                <tr>
                                    <td class="text-left py-0">@RulesList[Locali].RuleID</td>
                                    <td class="text-left py-0">@RulesList[Locali].ErrorID</td>
                                    <td class="text-left py-0">@RulesList[Locali].SubSystemID</td>
                                    <td class="text-left py-0">@RulesList[Locali].ModuleID</td>
                                    <td class="text-left py-0">@RulesList[Locali].UnitID</td>
                                    <td class="text-left py-0">@RulesList[Locali].SubTestID</td>
                                    <td class="text-left py-0">
                                        <div class="accordion accordion-primary" id="@($"{ParentId}_{Locali}")">
                                            <button class="accordion-button collapsed"
                                                    type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#@($"{CollapseId}_{Locali}")"
                                                    aria-controls="@($"{CollapseId}_{Locali}")"
                                                    aria-expanded="false"
                                                    style="background: transparent;">
                                                <span class="badge @RulesList[Locali].StatusClass">@RulesList[Locali].Status</span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="7" class="accordion-item py-0">
                                        <div id="@($"{CollapseId}_{Locali}")"
                                                class="accordion-collapse collapse"
                                                aria-labelledby="@($"{HeadingId}_{Locali}")"
                                                data-bs-parent="#@($"{ParentId}_{Locali}")">
                                            <div class="row">
                                                <div class="col-3">
                                                    Active: @RulesList[Locali].Active<br />
                                                    Number of Errors: @RulesList[Locali].NumOfErrors<br />
                                                    Severity: @RulesList[Locali].Severity<br />
                                                    Window Size: @RulesList[Locali].WindowSize<br />
                                                </div>
                                                <div class="col-6">
                                                    Param Type 1: @RulesList[Locali].Params[0].ParamType<br />
                                                    Param Type 2: @RulesList[Locali].Params[1].ParamType<br />
                                                    Param Type 3: @RulesList[Locali].Params[2].ParamType<br />
                                                    Param Type 4: @RulesList[Locali].Params[3].ParamType<br />
                                                </div>
                                                <div class="col-3">
                                                    Param 1: @RulesList[Locali].Params[0].Param<br />
                                                    Param 2: @RulesList[Locali].Params[1].Param<br />
                                                    Param 3: @RulesList[Locali].Params[2].Param<br />
                                                    Param 4: @RulesList[Locali].Params[3].Param<br />
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


@code {
    /* ---------- unique IDs via IdPrefix ---------- */
    [Parameter] public string IdPrefix { get; set; } = Guid.NewGuid().ToString("N");
    [Parameter] public string? TableStyle { get; set; }

    private string ParentId => $"accordion_IniRule_{IdPrefix}";
    private string HeadingId => $"heading_IniRule_{IdPrefix}";
    private string CollapseId => $"collapse_IniRule_{IdPrefix}";

    /* ---------- original component logic ---------- */

    [Parameter] public List<IniRule> RulesList { get; set; } = new();

    private int SortColumn = 0;     // –1 = none
    private bool SortUp = false;  // false = ⇣ (default)
    private List<IniRule>? OriginalRef;   // helper to detect replacement

    private string ArrowCss(int col) =>
        col == SortColumn
            ? $"avatar avatar-xs me-3 bg-primary avatar-rounded {(SortUp ? "rot-180" : "rot-0")}"
            : "avatar avatar-xs me-3 bg-gray-300 avatar-rounded";

    protected override void OnParametersSet()
    {
        // Different reference => new data loaded by parent
        if (OriginalRef != RulesList)
        {
            OriginalRef = RulesList;
            SortColumn = 0;
            SortUp = false;
            ApplySort();          // keep table always sorted
        }
    }
    
    private void ArrowClicked(int column)
    {
        if (column == SortColumn)           // clicked the active column  → flip dir
            SortUp = !SortUp;
        else                                 // clicked a new column       → activate
        {
            SortColumn = column;
            SortUp = false;             // default to ⇣ on first click
        }

        ApplySort();
    }

    private void ApplySort()
    {
        IEnumerable<IniRule> query = SortColumn switch
        {
            0 => RulesList.OrderBy(r => r.RuleID),
            1 => RulesList.OrderBy(r => r.SubSystemID),
            2 => RulesList.OrderBy(r => r.SubTestID),
            3 => RulesList.OrderBy(r => r.UnitID),
            4 => RulesList.OrderBy(r => r.ModuleID),
            5 => RulesList.OrderBy(r => r.ErrorID),
            _ => RulesList.OrderBy(r => r.RuleID)
        };

        if (SortUp) 
            query = query.Reverse();

        // replace content in-place so the table re-renders
        RulesList = query.ToList();
    }

}
